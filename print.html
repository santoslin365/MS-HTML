<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>opeco - 靈魂頻譜分析結果</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* 繼承版本一經典視覺與質感 UI */
        /* 繼承版本一經典視覺與質感 UI */
        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100vh;
            background-color: #000;
            overflow: hidden;
            max-width: 100vw;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif;
            color: #fff;
        }

        /* 背景容器：嚴格限制範圍 */
        .orb-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 0;
            pointer-events: none;
        }

        .orb {
            position: absolute;
            width: 600px;
            height: 600px;
            border-radius: 50%;
            filter: blur(120px);
            mix-blend-mode: screen;
            opacity: 0.5;
            will-change: transform;
        }

        .orb-1 {
            background: linear-gradient(45deg, #ff00ea, #00d2ff);
            top: -10%;
            left: -10%;
        }

        .orb-2 {
            background: linear-gradient(45deg, #00ff88, #ff0055);
            bottom: -10%;
            right: -10%;
        }

        .orb-3 {
            background: linear-gradient(45deg, #ffcc00, #0066ff);
            top: 50%;
            left: 50%;
        }

        /* 結果卡片容器 */
        /* 結果卡片容器 */
        #result-card {
            position: relative;
            /* 桌面版自適應寬度 */
            width: clamp(300px, 40vw, 600px);
            max-width: 90vw;
            padding: 50px 40px;
            text-align: center;

            /* Glassmorphism */
            background: rgba(30, 30, 35, 0.75);
            backdrop-filter: blur(40px) saturate(150%);
            -webkit-backdrop-filter: blur(40px) saturate(150%);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-top: 1px solid rgba(255, 255, 255, 0.25);
            border-radius: 32px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);

            opacity: 0;
            transform: translateY(20px);
            z-index: 10;
        }

        /* --- 手機版 RWD 適配 --- */
        @media (max-width: 768px) {
            #result-card {
                width: 85%;
                padding: 30px 20px;
            }

            #score-value {
                font-size: 4.5rem !important;
                /* 縮小分數顯示 */
            }

            #archetype-title {
                font-size: 1.8rem !important;
            }

            #archetype-desc {
                font-size: 1rem !important;
            }
        }

        h1 {
            font-size: 1.2rem;
            letter-spacing: 2px;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 20px;
            font-weight: normal;
        }

        /* 總分顯示 */
        #score-container {
            position: relative;
            margin-bottom: 20px;
        }

        #score-value {
            font-size: 6rem;
            font-weight: 700;
            background: linear-gradient(135deg, #fff, #aaa);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1;
        }

        #score-label {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.4);
            margin-top: -10px;
            display: block;
        }

        /* 原型結果 */
        #archetype-title {
            font-size: 2.2rem;
            margin: 20px 0 10px 0;
            font-weight: bold;
            text-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
            opacity: 0;
        }

        #archetype-desc {
            font-size: 1.1rem;
            line-height: 1.6;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 40px;
            opacity: 0;
        }

        /* 按鈕群組 */
        .btn-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            opacity: 0;
            /* 預設隱藏，等動畫顯示 */
        }

        /* 主按鈕 (下載圖片) */
        .primary-btn {
            display: inline-block;
            padding: 12px 40px;
            background: linear-gradient(45deg, #00d2ff, #00ff88);
            border: none;
            color: #000;
            font-weight: bold;
            font-size: 1rem;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            letter-spacing: 1px;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
        }

        .primary-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.6);
        }

        /* 次要按鈕 (結束測試) */
        .secondary-btn {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: rgba(255, 255, 255, 0.7);
            padding: 8px 30px;
            font-size: 0.9rem;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .secondary-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border-color: #fff;
        }
    </style>
</head>

<body>

    <div class="orb-container">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <div class="orb orb-3"></div>
    </div>

    <div id="result-card">
        <h1>靈魂頻譜分析完成</h1>

        <div id="player-info" style="margin-bottom: 20px; font-size: 0.9rem; color: #00ff88; opacity: 0.8;">
            <div id="player-nickname"></div>
            <div id="player-uid" style="font-size: 0.8rem; color: #888;"></div>
        </div>

        <div id="score-container">
            <div id="score-value">0</div>
            <span id="score-label">SYNC RATIO</span>
        </div>

        <div id="archetype-title">載入中...</div>
        <div id="archetype-desc">正在解碼您的靈魂數據...</div>

        <!-- 按鈕區塊 -->
        <div class="btn-group">
            <!-- 1. 下載圖片 (主按鈕) -->
            <div class="primary-btn" onclick="downloadCard()">下載圖片</div>
            <!-- 2. 結束測試 (次要按鈕) -->
            <div class="secondary-btn" onclick="endTest()">結束測試</div>
        </div>
    </div>

    <script>
        // 1. 動畫背景
        let orbSpeed = 0.5; // 慢速流動
        document.querySelectorAll('.orb').forEach((orb, i) => {
            const move = () => { gsap.to(orb, { x: (Math.random() - 0.5) * window.innerWidth, y: (Math.random() - 0.5) * window.innerHeight, duration: (10 + i * 5) / orbSpeed, ease: "sine.inOut", onComplete: move }); };
            move();
        });

        // 2. 讀取分數與邏輯
        const totalScore = parseInt(sessionStorage.getItem('opeco_total_score') || 0);
        const nickname = sessionStorage.getItem('opeco_nickname') || "經紀人";
        const uid = sessionStorage.getItem('opeco_uid') || "Unknown";

        // 更新玩家資訊
        document.getElementById('player-nickname').innerText = `經紀人：${nickname}`;
        document.getElementById('player-uid').innerText = `UID: ${uid}`;

        let archetype = { title: "", desc: "", color: "" };

        // 靈魂原型邏輯
        if (totalScore >= 24) {
            archetype = {
                title: "【 恆星 Stellar 】",
                desc: "您的靈魂如同恆星般燃燒，充滿主動性與創造力。您不等待光芒，因為您就是光芒本身。",
                color: "#ffcc00"
            };
        } else if (totalScore >= 14) {
            archetype = {
                title: "【 星雲 Nebula 】",
                desc: "您擁有海納百川的包容力，如同星雲般孕育無限可能。您的強大在於適應與轉化，而非對抗。",
                color: "#00d2ff"
            };
        } else {
            archetype = {
                title: "【 黑洞 Black Hole 】",
                desc: "深邃、神秘且擁有不可抗拒的引力。您不輕易顯露情感，但內心卻擁有最強大的意志核心。",
                color: "#a900ff"
            };
        }

        // 3. 進場與數字動畫
        window.onload = () => {
            // 卡片進場
            gsap.to("#result-card", { opacity: 1, y: 0, duration: 1, ease: "power3.out" });

            // 數字跑動
            const scoreObj = { val: 0 };
            gsap.to(scoreObj, {
                val: totalScore,
                duration: 2,
                ease: "power2.out",
                onUpdate: () => {
                    document.getElementById("score-value").innerText = Math.round(scoreObj.val);
                },
                onComplete: () => {
                    showArchetype();
                }
            });
        };

        function showArchetype() {
            const titleEl = document.getElementById("archetype-title");
            const descEl = document.getElementById("archetype-desc");
            const btnGroup = document.querySelector(".btn-group");

            titleEl.innerText = archetype.title;
            titleEl.style.color = archetype.color;
            titleEl.style.textShadow = `0 0 30px ${archetype.color}`;

            descEl.innerText = archetype.desc;

            // 依序淡入
            gsap.to(titleEl, { opacity: 1, y: -5, duration: 0.8, delay: 0 });
            gsap.to(descEl, { opacity: 1, y: -5, duration: 0.8, delay: 0.3 });
            gsap.to(btnGroup, { opacity: 1, y: 0, duration: 0.8, delay: 0.8 });
        }

        // --- 下載圖片功能 ---
        // --- 下載圖片功能 ---
        function downloadCard() {
            const card = document.getElementById('result-card');

            // 修正：使用 onclone 處理截圖時的特殊樣式，不直接操作 DOM
            html2canvas(card, {
                backgroundColor: null, // 透明背景
                scale: 2, // 提高解析度 (Retina)
                onclone: (clonedDoc) => {
                    // 1. 修正分數的灰色背景 (html2canvas 對 background-clip: text 支援度不佳的問題)
                    // 在截圖時將其改回純白字體
                    const scoreEl = clonedDoc.getElementById('score-value');
                    if (scoreEl) {
                        scoreEl.style.background = 'none';
                        scoreEl.style.webkitTextFillColor = 'initial';
                        scoreEl.style.color = '#ffffff';
                    }

                    // 2. 在截圖中直接隱藏按鈕群組 (比操作 display:none 更穩)
                    const btnGroup = clonedDoc.querySelector('.btn-group');
                    if (btnGroup) {
                        btnGroup.style.display = 'none';
                    }
                }
            }).then(canvas => {
                // 下載觸發
                const link = document.createElement('a');
                link.download = `opeco-soul-${nickname}.png`;
                link.href = canvas.toDataURL();
                link.click();
            }).catch(err => {
                console.error("截圖失敗:", err);
                alert("圖片下載失敗，請稍後再試。");
            });
        }

        // --- 結束測試 (原 Restart) ---
        function endTest() {
            // 清除資料
            sessionStorage.removeItem('opeco_history');
            sessionStorage.removeItem('opeco_system');
            sessionStorage.removeItem('opeco_total_score');
            sessionStorage.removeItem('opeco_nickname');
            sessionStorage.removeItem('opeco_uid');

            // 淡出效果
            gsap.to("body", {
                opacity: 0, duration: 1, onComplete: () => {
                    window.location.href = 'index.html';
                }
            });
        }

    </script>
</body>

</html>